name: "Periodic Code Cleanliness Review"

on:
  schedule:
    # Run every 12 hours (at 00:00 and 12:00 UTC)
    - cron: '0 0,12 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  code-cleanliness-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@main
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Analyze Large Files
        id: analyze
        run: |
          echo "## Large Files Analysis" > /tmp/analysis.md
          echo "" >> /tmp/analysis.md
          echo "Files larger than 500 lines that may benefit from splitting:" >> /tmp/analysis.md
          echo "" >> /tmp/analysis.md
          
          # Find files larger than 500 lines (excluding common large files)
          find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.go" -o -name "*.cs" -o -name "*.rb" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/build/*" \
            ! -path "*/.venv/*" \
            ! -path "*/vendor/*" \
            -exec wc -l {} \; | \
            awk '$1 > 500 {print $1 " lines: " $2}' | \
            sort -rn >> /tmp/analysis.md || echo "No large files found" >> /tmp/analysis.md
          
          echo "" >> /tmp/analysis.md
          echo "## Code Complexity Analysis" >> /tmp/analysis.md
          echo "" >> /tmp/analysis.md
          echo "Files with potential complexity issues:" >> /tmp/analysis.md
          
          # Find files with many functions/classes (basic heuristic)
          for ext in py js ts java go cs rb; do
            if [ "$ext" = "py" ]; then
              pattern="^def |^class "
            elif [ "$ext" = "js" ] || [ "$ext" = "ts" ]; then
              pattern="^function |^class |const.*=.*=>|function.*{$"
            else
              pattern="^class |^def |^func "
            fi
            
            find . -type f -name "*.$ext" \
              ! -path "*/node_modules/*" \
              ! -path "*/dist/*" \
              ! -path "*/build/*" \
              ! -path "*/.venv/*" \
              ! -path "*/vendor/*" \
              -exec sh -c 'count=$(grep -c "$1" "$2" 2>/dev/null || echo 0); count=$(echo "$count" | tr -d "\n\r\t " | grep -E "^[0-9]+$" || echo 0); if [ "$count" -gt 20 ] 2>/dev/null; then echo "$count definitions in $2"; fi' _ "$pattern" {} \; \
              2>/dev/null || true
          done | sort -rn >> /tmp/analysis.md
          
          cat /tmp/analysis.md

      - name: Code Quality Analysis
        run: |
          echo "## Code Quality Analysis" > /tmp/quality-analysis.md
          echo "" >> /tmp/quality-analysis.md
          
          # Check for code complexity indicators
          echo "### Code Complexity Analysis:" >> /tmp/quality-analysis.md
          
          # Find large files that might need refactoring
          echo "" >> /tmp/quality-analysis.md
          echo "#### Large Files (>500 lines):" >> /tmp/quality-analysis.md
          find . -name "*.c" -o -name "*.cc" -o -name "*.cpp" -o -name "*.h" -o -name "*.hh" -o -name "*.py" -o -name "*.js" -o -name "*.ts" | \
            while read -r file; do
              if [ -f "$file" ]; then
                lines=$(wc -l < "$file" 2>/dev/null || echo 0)
                lines=$(echo "$lines" | tr -d '\n\r\t ' | grep -E '^[0-9]+$' || echo 0)
                lines=${lines:-0}
                if [ "$lines" -gt 500 ] 2>/dev/null; then
                  echo "⚠️ $file: $lines lines (consider splitting)" >> /tmp/quality-analysis.md
                fi
              fi
            done
          
          # Check for potential code duplication patterns
          echo "" >> /tmp/quality-analysis.md
          echo "#### Potential Code Duplication:" >> /tmp/quality-analysis.md
          
          # Look for repeated function signatures or similar patterns
          if find . -name "*.c" -o -name "*.cc" -o -name "*.cpp" | head -10 | xargs grep -h "^[a-zA-Z_][a-zA-Z0-9_]* [a-zA-Z_][a-zA-Z0-9_]*(" 2>/dev/null | sort | uniq -d | head -5 | grep -q .; then
            echo "⚠️ Found potential duplicate function signatures" >> /tmp/quality-analysis.md
          else
            echo "✅ No obvious function signature duplication detected" >> /tmp/quality-analysis.md
          fi
          
          # Check for consistent naming conventions
          echo "" >> /tmp/quality-analysis.md
          echo "#### Code Style Consistency:" >> /tmp/quality-analysis.md
          
          # Check for mixed naming conventions in headers
          mixed_naming=0
          if find . -name "*.h" -o -name "*.hh" | head -5 | xargs grep -h "^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*(" 2>/dev/null | grep -q "[A-Z]"; then
            if find . -name "*.h" -o -name "*.hh" | head -5 | xargs grep -h "^[[:space:]]*[a-z_][a-z0-9_]*[[:space:]]*(" 2>/dev/null | grep -q "_"; then
              mixed_naming=1
            fi
          fi
          
          if [ $mixed_naming -eq 1 ]; then
            echo "⚠️ Mixed naming conventions detected (camelCase and snake_case)" >> /tmp/quality-analysis.md
          else
            echo "✅ Consistent naming convention appears to be used" >> /tmp/quality-analysis.md
          fi
          
          cat /tmp/quality-analysis.md
        continue-on-error: true

      - name: Create Issue for Code Cleanliness Review
        uses: actions/github-script@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/analysis.md', 'utf8');
            
            let qualityAnalysis = '';
            try {
              qualityAnalysis = fs.readFileSync('/tmp/quality-analysis.md', 'utf8');
            } catch (e) {
              qualityAnalysis = 'Quality analysis not available.';
            }
            
            const date = new Date().toISOString().split('T')[0];
            const title = `Code Cleanliness Review - ${date}`;
            
            const body = `# Periodic Code Cleanliness Review
            
            This is an automated review conducted every 12 hours to maintain code quality.
            
            ${analysis}
            
            ${qualityAnalysis}
            
            ## Recommendations
            
            Please review the analysis above and:
            1. Split large files (>500 lines) into smaller, focused modules
            2. Refactor complex functions into smaller, testable units
            3. Remove code duplication
            4. Ensure consistent code style
            5. Improve code organization and structure
            
            ## Next Steps
            
            - Assign this issue to relevant team members
            - Create follow-up PRs to address findings
            - Document any architectural decisions
            
            ---
            *This issue was automatically generated by the Code Cleanliness Review workflow.*
            `;
            
            // Check if similar issue exists (open, created in last 24 hours)
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['code-cleanliness', 'automated'],
              per_page: 10
            });
            
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const hoursSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60);
              return hoursSinceCreation < 24;
            });
            
            if (recentIssue) {
              console.log(`Recent issue found: #${recentIssue.number}, skipping creation`);
              // Update existing issue with new analysis
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## Updated Analysis (${date})\n\n${analysis}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['code-cleanliness', 'automated', 'needs-review']
              });
            }
