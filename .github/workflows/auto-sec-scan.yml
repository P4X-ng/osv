name: "Security Scan on PR"
on:
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  security_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@main
        with:
          submodules: recursive
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib
          sudo apt-get install -y libboost-all-dev
          sudo apt-get install -y git make
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@main
        with:
          languages: 'cpp,python,java'
      
      - name: Build for CodeQL Analysis
        run: |
          # Create a minimal build to satisfy CodeQL C++ analysis
          # We'll compile just the core source files that CodeQL needs to analyze
          make -j$(nproc) mode=release arch=x64 || true
          
          # If full build fails, try to compile individual source files
          if [ $? -ne 0 ]; then
            echo "Full build failed, attempting to compile core files individually..."
            mkdir -p build/release.x64/core
            
            # Compile the commands.cc file specifically since that's what we modified
            g++ -std=gnu++11 -I./include -I./arch/x64 -I./build/release.x64/gen/include \
                -c core/commands.cc -o build/release.x64/core/commands.o || echo "commands.cc compilation failed"
            
            # Try to compile other core files
            for file in core/*.cc; do
              if [ -f "$file" ]; then
                basename=$(basename "$file" .cc)
                echo "Compiling $file..."
                g++ -std=gnu++11 -I./include -I./arch/x64 -I./build/release.x64/gen/include \
                    -c "$file" -o "build/release.x64/core/${basename}.o" || echo "$file compilation failed"
              fi
            done
          fi
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@main