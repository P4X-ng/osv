name: "Comprehensive Test Review with Playwright"

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  test-review-and-execution:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        mode: [headed, headless]
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Detect Project Type
        id: project_type
        run: |
          # Detect if this is a web project that needs Playwright
          if [ -f "package.json" ] || [ -f "playwright.config.js" ] || [ -f "playwright.config.ts" ]; then
            echo "is_web_project=true" >> $GITHUB_OUTPUT
            echo "Project type: Web/JavaScript project - Playwright applicable"
          elif [ -f "Makefile" ] && ! [ -f "package.json" ]; then
            # Additional checks for C/C++/systems projects
            if [ -f "CMakeLists.txt" ] || [ -f "configure" ] || [ -f "configure.ac" ] || \
               find . -maxdepth 3 -name "*.c" -o -name "*.cc" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp" 2>/dev/null | head -1 | grep -q .; then
              echo "is_web_project=false" >> $GITHUB_OUTPUT
              echo "Project type: C/C++/Systems project - Playwright not applicable"
            else
              echo "is_web_project=maybe" >> $GITHUB_OUTPUT
              echo "Project type: Make-based but unclear - will attempt Playwright tests"
            fi
          else
            echo "is_web_project=maybe" >> $GITHUB_OUTPUT
            echo "Project type: Unknown - will attempt Playwright tests"
          fi

      - name: Setup Node.js
        if: steps.project_type.outputs.is_web_project != 'false'
        uses: actions/setup-node@main
        with:
          node-version: '20'
          cache: 'npm'
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@main
        with:
          python-version: '3.11'
          cache: 'pip'
        continue-on-error: true

      - name: Install Node.js dependencies
        if: steps.project_type.outputs.is_web_project != 'false'
        run: |
          if [ -f "package.json" ]; then
            npm install
            npm install -D @playwright/test playwright
          fi
        continue-on-error: true

      - name: Install Python dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          pip install pytest playwright pytest-playwright
        continue-on-error: true

      - name: Install Playwright browsers
        if: steps.project_type.outputs.is_web_project != 'false'
        run: |
          npx playwright install --with-deps ${{ matrix.browser }} || python -m playwright install --with-deps ${{ matrix.browser }}
        continue-on-error: true

      - name: Verify Playwright installation
        if: steps.project_type.outputs.is_web_project != 'false'
        run: |
          echo "Checking Playwright installation..."
          npx playwright --version || python -m playwright --version || echo "Playwright not installed"

      - name: Run Playwright Tests (Headless)
        if: matrix.mode == 'headless' && steps.project_type.outputs.is_web_project != 'false'
        run: |
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            npx playwright test --browser=${{ matrix.browser }}
          elif [ -d "tests" ] && find tests -name "*test*.py" -o -name "*_test.py" | grep -q .; then
            pytest tests/ --browser ${{ matrix.browser }} --headed=false
          else
            echo "No Playwright tests found - this is OK if not a web project"
          fi
        env:
          CI: true
        continue-on-error: true

      - name: Run Playwright Tests (Headed)
        if: matrix.mode == 'headed' && steps.project_type.outputs.is_web_project != 'false'
        run: |
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            npx playwright test --browser=${{ matrix.browser }} --headed
          elif [ -d "tests" ] && find tests -name "*test*.py" -o -name "*_test.py" | grep -q .; then
            pytest tests/ --browser ${{ matrix.browser }} --headed=true
          else
            echo "No Playwright tests found - this is OK if not a web project"
          fi
        env:
          CI: true
          DISPLAY: :99
        continue-on-error: true

      - name: Upload Playwright Test Results
        uses: actions/upload-artifact@main
        if: always()
        with:
          name: playwright-results-${{ matrix.browser }}-${{ matrix.mode }}
          path: |
            playwright-report/
            test-results/
            playwright-traces/
          retention-days: 30
        continue-on-error: true

      - name: Upload Playwright Screenshots on Failure
        uses: actions/upload-artifact@main
        if: failure()
        with:
          name: playwright-screenshots-${{ matrix.browser }}-${{ matrix.mode }}
          path: |
            screenshots/
            test-results/**/screenshots/
          retention-days: 7
        continue-on-error: true

  test-coverage-review:
    runs-on: ubuntu-latest
    needs: test-review-and-execution
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Analyze Test Coverage
        id: coverage
        run: |
          echo "## Test Coverage Analysis" > /tmp/test-analysis.md
          echo "" >> /tmp/test-analysis.md
          
          # Find test files
          echo "### Test Files Found:" >> /tmp/test-analysis.md
          find . -type f \( -name "*test*.js" -o -name "*test*.ts" -o -name "*test*.py" -o -name "*spec*.js" -o -name "*spec*.ts" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/.venv/*" \
            -exec echo "- {}" \; >> /tmp/test-analysis.md || echo "No test files found" >> /tmp/test-analysis.md
          
          echo "" >> /tmp/test-analysis.md
          echo "### Source Files Without Tests:" >> /tmp/test-analysis.md
          
          # Find source files that might need tests
          for file in $(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/build/*" \
            ! -path "*/.venv/*" \
            ! -path "*/vendor/*" \
            ! -name "*test*" \
            ! -name "*spec*"); do
            basename=$(basename "$file" | sed 's/\.[^.]*$//')
            
            # Check if corresponding test file exists
            if ! find . -name "*${basename}*test*" -o -name "*${basename}*spec*" 2>/dev/null | grep -q .; then
              echo "- $file (no corresponding test found)" >> /tmp/test-analysis.md
            fi
          done
          
          cat /tmp/test-analysis.md

      - name: Test Coverage Analysis
        run: |
          echo "## Test Coverage Analysis" > /tmp/coverage-analysis.md
          echo "" >> /tmp/coverage-analysis.md
          
          # Detect project type
          echo "### Project Type Detection:" >> /tmp/coverage-analysis.md
          if [ -f "Makefile" ] && ! [ -f "package.json" ]; then
            # Additional checks for C/C++/systems projects
            if [ -f "CMakeLists.txt" ] || [ -f "configure" ] || [ -f "configure.ac" ] || \
               find . -maxdepth 3 -name "*.c" -o -name "*.cc" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp" 2>/dev/null | head -1 | grep -q .; then
              echo "ðŸ“¦ **Project Type**: C/C++/Systems Programming Project" >> /tmp/coverage-analysis.md
              echo "â„¹ï¸ Playwright testing is not applicable for this project type" >> /tmp/coverage-analysis.md
              echo "" >> /tmp/coverage-analysis.md
            fi
          elif [ -f "package.json" ]; then
            echo "ðŸ“¦ **Project Type**: JavaScript/TypeScript/Web Project" >> /tmp/coverage-analysis.md
            echo "" >> /tmp/coverage-analysis.md
          fi
          
          # Check for test framework indicators
          echo "### Test Framework Detection:" >> /tmp/coverage-analysis.md
          
          # Check for Playwright only if web project
          if [ -f "package.json" ]; then
            if [ -f "playwright.config.js" ] || [ -f "playwright.config.ts" ] || grep -r "playwright" package.json 2>/dev/null; then
              echo "âœ… Playwright configuration detected" >> /tmp/coverage-analysis.md
            else
              echo "âš ï¸ No Playwright configuration found" >> /tmp/coverage-analysis.md
            fi
            
            # Check for other test frameworks
            if grep -r "jest\|mocha\|jasmine\|vitest" package.json 2>/dev/null; then
              echo "âœ… JavaScript test framework detected" >> /tmp/coverage-analysis.md
            fi
          else
            echo "â„¹ï¸ Playwright not applicable - this is not a web project" >> /tmp/coverage-analysis.md
          fi
          
          # Check for existing test files
          if find . -name "*.test.js" -o -name "*.test.ts" -o -name "*.spec.js" -o -name "*.spec.ts" -o -name "*.test.py" -o -name "*test*.cc" -o -name "*test*.cpp" 2>/dev/null | grep -q .; then
            echo "âœ… Test files found" >> /tmp/coverage-analysis.md
          else
            echo "âš ï¸ No test files detected" >> /tmp/coverage-analysis.md
          fi
          
          # Check for test directories
          echo "" >> /tmp/coverage-analysis.md
          echo "### Test Organization:" >> /tmp/coverage-analysis.md
          
          for dir in tests test __tests__ spec e2e; do
            if [ -d "$dir" ]; then
              test_count=$(find "$dir" -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.cc" -o -name "*.cpp" | wc -l)
              echo "âœ… Found $dir/ directory with $test_count test files" >> /tmp/coverage-analysis.md
            fi
          done
          
          # Check for CI test configuration
          echo "" >> /tmp/coverage-analysis.md
          echo "### CI/CD Test Integration:" >> /tmp/coverage-analysis.md
          
          if find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | xargs grep -l "test\|playwright" 2>/dev/null | grep -q .; then
            echo "âœ… Tests appear to be integrated in CI/CD" >> /tmp/coverage-analysis.md
          else
            echo "âš ï¸ No test integration found in CI/CD workflows" >> /tmp/coverage-analysis.md
          fi
          
          cat /tmp/coverage-analysis.md
        continue-on-error: true

      - name: Create or Update Test Review Issue
        uses: actions/github-script@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/test-analysis.md', 'utf8');
            
            let coverageAnalysis = '';
            try {
              coverageAnalysis = fs.readFileSync('/tmp/coverage-analysis.md', 'utf8');
            } catch (e) {
              coverageAnalysis = 'Coverage analysis not available.';
            }
            
            const date = new Date().toISOString().split('T')[0];
            const title = `Test Coverage Review - ${date}`;
            
            // Detect if this is a web project
            const isWebProject = coverageAnalysis.includes('JavaScript/TypeScript/Web Project');
            const playwrightNotApplicable = coverageAnalysis.includes('Playwright not applicable');
            
            let playwrightSection = '';
            let recommendations = '';
            
            if (playwrightNotApplicable) {
              playwrightSection = `## Playwright Test Status
              
              â„¹ï¸ **Playwright testing is not applicable for this project type**
              
              This project is a C/C++/Systems programming project and does not require Playwright browser testing.
              The project has its own appropriate test infrastructure for the technology stack being used.
              `;
              
              recommendations = `## Recommendations
              
              1. **Maintain existing test infrastructure** appropriate for C/C++/systems projects
              2. **Add tests** for critical functionality without coverage
              3. **Review test quality** and maintainability
              4. **Fix flaky tests** and timing issues
              5. **Ensure CI/CD integration** for all tests
              6. **Document test execution** procedures
              `;
            } else {
              playwrightSection = `## Playwright Test Status
              
              ${isWebProject ? 'âœ… Tests run in multiple browsers: Chromium, Firefox, WebKit\nâœ… Tests run in both headed and headless modes' : 'âš ï¸ Playwright tests not detected'}
              `;
              
              recommendations = `## Recommendations
              
              1. **Add Playwright tests** for all web-based functionality
              2. **Migrate existing web tests** to Playwright if not already using it
              3. **Add tests** for source files without coverage
              4. **Review test quality** and maintainability
              5. **Fix flaky tests** and timing issues
              6. **Ensure CI/CD integration** for all tests
              `;
            }
            
            const body = `# Comprehensive Test Review
            
            This automated review analyzes test coverage for the project.
            
            ${analysis}
            
            ${coverageAnalysis}
            
            ${playwrightSection}
            
            ${recommendations}
            
            ## Action Items
            
            - [ ] Review files without tests and add coverage where appropriate
            ${playwrightNotApplicable ? '' : '- [ ] Migrate non-Playwright web tests to Playwright'}
            - [ ] Fix any failing tests
            - [ ] Add documentation for test setup and execution
            
            ---
            *This issue was automatically generated by the Test Review workflow.*
            `;
            
            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['test-coverage', 'automated'],
              per_page: 10
            });
            
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const daysSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60 * 24);
              return daysSinceCreation < 7;
            });
            
            if (recentIssue) {
              console.log(`Recent issue found: #${recentIssue.number}, updating`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## Updated Analysis (${date})\n\n${analysis}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['test-coverage', 'automated', 'playwright', 'needs-review']
              });
            }
